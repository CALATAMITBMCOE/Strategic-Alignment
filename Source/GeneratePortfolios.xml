<gel:script xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:core="jelly:core"
    xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
    xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
    xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary"
    xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:sql="jelly:sql" xmlns:xog="http://www.niku.com/xog"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

    <core:set value="${gel_objectInstanceId}" var="vItem_Intl"/>

	<core:if test="${DebugLevel &gt; 0}">
		<gel:log level="debug" message="Start Script"/>
		<gel:log level="debug" message=">>Strategic Item ID   : ${vItem_Intl}"/> 
		<gel:log level="debug" message=">>Persisted XOG URL   : ${XOGURL}"/> 
		<gel:log level="debug" message=">>Persisted LOG Folder: ${XOGlogFolder}"/> 
		<gel:log level="debug" message=">>Persisted WEB Folder: ${XOGwebFolder}"/> 
		<gel:log level="debug" message=">>Persisted SessionID : ${sessionID}"/> 
		<gel:log level="debug" message=">>Persisted DebugLevel: ${DebugLevel}"/> 
	</core:if>

	<gel:parse var="v_xml_portfolios">
		<NikuDataBus xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../xsd/nikuxog_portfolio.xsd">
			<Header action="write" externalSource="NIKU" objectType="portfolio" version="13.0"/>
			<portfolios/>
		</NikuDataBus>
	</gel:parse>
	
	<gel:parse var="v_xml_items">
		<NikuDataBus xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../xsd/nikuxog_customObjectInstance.xsd">
			<Header action="write" externalSource="NIKU" objectType="customObjectInstance" version="13.0"/>
				<customObjectInstances objectCode="strategic_item"/>
		</NikuDataBus>
	</gel:parse>

    <gel:setDataSource dbId="niku"/>

    <!-- Reading Hierarchy Data-->
    <sql:query escapeText="false" var="vHier">
		Select substr(SI.NAME,1,32), SI.CODE, U.USER_NAME, 
				SI.PLAN_BEN, SI.PLAN_COST, SI.CURRENCY_CODE, SI.COPY_INVESTMENTS,
				to_char(SI.PLAN_START_DATE,'YYYY-MM-DD'), to_char(SI.PLAN_FINISH_DATE, 'YYYY-MM-DD'),
				SUM(CHILD.TARGET_DISTRIBUTION)
		FROM ODF_CA_STRATEGIC_ITEM SI
			INNER JOIN SRM_RESOURCES R on R.ID = SI.PORTFOLIO_MANAGER
			INNER JOIN CMN_SEC_USERS U on U.ID = R.USER_ID
			INNER JOIN ODF_CA_STRATEGIC_ITEM CHILD ON CHILD.PARENTITEM = SI.ID AND CHILD.ACTIVE = 1
		WHERE SI.ID = ${vItem_Intl}
		GROUP BY substr(SI.NAME,1,32), SI.CODE, U.USER_NAME, SI.PLAN_BEN, SI.PLAN_COST, SI.CURRENCY_CODE, SI.COPY_INVESTMENTS, to_char(SI.PLAN_START_DATE,'YYYY-MM-DD'), to_char(SI.PLAN_FINISH_DATE, 'YYYY-MM-DD')
	</sql:query>
    <core:forEach items="${vHier.rowsByIndex}" var="row">
        <core:set var="vItem_Name">${row[0]}</core:set>
        <core:set var="vItem_Code">${row[1]}</core:set>
        <core:set var="vItem_User">${row[2]}</core:set>
        <core:set var="vItem_Benf">${row[3]}</core:set>
        <core:set var="vItem_Cost">${row[4]}</core:set>
        <core:set var="vItem_Curr">${row[5]}</core:set>
        <core:set var="vItem_Copy">${row[6]}</core:set>
        <core:set var="vItem_sDat">${row[7]}</core:set>
        <core:set var="vItem_fDat">${row[8]}</core:set>
        <core:set var="vItem_Perc">${row[9]}</core:set>
		<core:if test="${DebugLevel &gt; 0}">
			<gel:log level="debug" message="Found Hierarchy: ${vItem_Code}-${vItem_Name}. Created by ${vItem_User}. Percentage SUM = ${vItem_Perc}. Copy Investments = ${vItem_Copy}"/> 
		</core:if>
    </core:forEach>

	<core:choose>
		<core:when test="${vItem_Perc == 1}">
			<core:if test="${DebugLevel &gt; 0}">
				<gel:log level="debug" message="Item Percentage Sum is 100%: ${vItem_Perc}."/> 
			</core:if>

			<!--Parent Portfolio-->
			<gel:parse var="v_Portfolio_Instance">
				<portfolio active="1" budgetBenefit="${vItem_Benf}" budgetCost="${vItem_Cost}" budgetType="BUDGET_TYPE_TOTAL" capacityType="CAPACITY_TYPE_TOTAL"
					capacityUnitType="CAPACITY_UNIT_TYPE_HOURS" currencyISOcode="${vItem_Curr}" description="${vItem_Name}" finish="${vItem_fDat}T00:00:00"
					id="${vItem_Code}" invType="all" manager="${vItem_User}" name="${vItem_Name}" pageLayoutCode="cop.pge.pflLayout" start="${vItem_sDat}T00:00:00">
					<contents/>
					<CustomInformation>
						<ColumnValue name="partition_code">NIKU.ROOT</ColumnValue>
					</CustomInformation>
				</portfolio>
			</gel:parse>

			<core:if test="${vItem_Copy == 1}">
				<sql:query escapeText="false" var="vContents">
					SELECT DISTINCT I.NAME, I.CODE, 
						case
							when I.ODF_OBJECT_CODE = 'asset' 
							then 'INV_ASSETS'
							when I.ODF_OBJECT_CODE = 'application' 
							then 'INV_APPLICATION'
							when I.ODF_OBJECT_CODE = 'other' 
							then 'INV_OTHER'
							when I.ODF_OBJECT_CODE = 'idea' 
							then 'INV_IDEA'
							when I.ODF_OBJECT_CODE = 'product' 
							then 'INV_PRODUCTS'
							when I.ODF_OBJECT_CODE = 'service' 
							then 'INV_SERVICES'
							when I.ODF_OBJECT_CODE = 'project' 
							then	 'SRM_PROJECTS'
						end Type
					FROM ODF_CA_STRAT_TREE_FLAT ST
						inner join ODF_MULTI_VALUED_LOOKUPS MVL
							on MVL.attribute = 'strat_sup_goals' AND MVL.OBJECT in ('application','asset', 'service', 'idea', 'other', 'product', 'project') 
							AND MVL.VALUE= ST.CHILD_ITEM 
						inner join INV_INVESTMENTS I
							on I.ID = MVL.PK_ID
					WHERE ST.PARENT_ITEM = ${vItem_Intl}
				</sql:query>
				<core:forEach items="${vContents.rowsByIndex}" var="row">
					<core:set var="vInv_Name">${row[0]}</core:set>
					<core:set var="vInv_Code">${row[1]}</core:set>
					<core:set var="vInv_Type">${row[2]}</core:set>
					<core:if test="${DebugLevel &gt; 0}">
						<gel:log level="debug" message="Found Investment: ${vInv_Code}-${vInv_Name}-${vInv_Type}."/> 
					</core:if>
		
					<gel:parse var="v_Content_Instance">
						<investment investmentID="${vInv_Code}" investmentType="${vInv_Type}"/>
					</gel:parse>
					<gel:set insert="true" select="$v_Portfolio_Instance/portfolio/contents" value="${v_Content_Instance}"/>
				</core:forEach>
			</core:if>
			
			<gel:set insert="true" select="$v_xml_portfolios/NikuDataBus/portfolios" value="${v_Portfolio_Instance}"/>
			
			<!--Parent Item-->
			<gel:parse var="v_Item_Instance">
				<instance instanceCode="${vItem_Code}" objectCode="strategic_item">
					<CustomInformation>
						<ColumnValue name="strat_portfolio">${vItem_Code}</ColumnValue>
					</CustomInformation>
				</instance>
			</gel:parse>
			<gel:set insert="true" select="$v_xml_items/NikuDataBus/customObjectInstances" value="${v_Item_Instance}"/>

			<!-- Verifying Children Data-->
			<sql:query escapeText="false" var="vChildren">
				Select substr(SI.NAME,1,32), SI.CODE, SI.ID, SI.TARGET_DISTRIBUTION, SI.TARGET_DISTRIBUTION * ${vItem_Benf}, SI.TARGET_DISTRIBUTION * ${vItem_Cost}
				FROM ODF_CA_STRATEGIC_ITEM SI
				WHERE SI.PARENTITEM = ${vItem_Intl}
			</sql:query>
			<core:forEach items="${vChildren.rowsByIndex}" var="row">
				<core:set var="vChild_Name">${row[0]}</core:set>
				<core:set var="vChild_Code">${row[1]}</core:set>
				<core:set var="vChild_Intl">${row[2]}</core:set>
				<core:set var="vChild_Perc">${row[3]}</core:set>
				<core:set var="vChild_Benf">${row[4]}</core:set>
				<core:set var="vChild_Cost">${row[5]}</core:set>
				<core:if test="${DebugLevel &gt; 0}">
					<gel:log level="debug" message="Found Child: ${vChild_Code}-${vChild_Name}. Target Percent ${vChild_Perc}. Calc Benefit=${vChild_Benf}. Calc Cost=${vChild_Cost}."/> 
				</core:if>
				<gel:parse var="v_Item_Instance">
					<instance instanceCode="${vChild_Code}" objectCode="strategic_item">
						<CustomInformation>
							<ColumnValue name="tg_plan_ben">${vChild_Benf}</ColumnValue>
							<ColumnValue name="tg_plan_cst">${vChild_Cost}</ColumnValue>
							<ColumnValue name="strat_portfolio">${vChild_Code}</ColumnValue>
						</CustomInformation>
					</instance>
				</gel:parse>
				<gel:set insert="true" select="$v_xml_items/NikuDataBus/customObjectInstances" value="${v_Item_Instance}"/>
				
				<gel:parse var="v_Portfolio_Instance">
					<portfolio active="1" budgetBenefit="${vChild_Benf}" budgetCost="${vChild_Cost}" budgetType="BUDGET_TYPE_TOTAL" capacityType="CAPACITY_TYPE_TOTAL"
						capacityUnitType="CAPACITY_UNIT_TYPE_HOURS" currencyISOcode="${vItem_Curr}" description="${vChild_Name}" finish="${vItem_fDat}T00:00:00"
						id="${vChild_Code}" invType="all" manager="${vItem_User}" name="${vChild_Name}" pageLayoutCode="cop.pge.pflLayout" start="${vItem_sDat}T00:00:00" parentPortfolioID="${vItem_Code}">
						<contents/>
						<CustomInformation>
							<ColumnValue name="partition_code">NIKU.ROOT</ColumnValue>
						</CustomInformation>
					</portfolio>
				</gel:parse>
				
				<core:if test="${vItem_Copy == 1}">
					<sql:query escapeText="false" var="vContents">
						SELECT DISTINCT I.NAME, I.CODE, 
							case
								when I.ODF_OBJECT_CODE = 'asset' 
								then 'INV_ASSETS'
								when I.ODF_OBJECT_CODE = 'application' 
								then 'INV_APPLICATION'
								when I.ODF_OBJECT_CODE = 'other' 
								then 'INV_OTHER'
								when I.ODF_OBJECT_CODE = 'idea' 
								then 'INV_IDEA'
								when I.ODF_OBJECT_CODE = 'product' 
								then 'INV_PRODUCTS'
								when I.ODF_OBJECT_CODE = 'service' 
								then 'INV_SERVICES'
								when I.ODF_OBJECT_CODE = 'project' 
								then 'SRM_PROJECTS'
							end Type
						FROM ODF_CA_STRAT_TREE_FLAT ST
							inner join ODF_MULTI_VALUED_LOOKUPS MVL
								on MVL.attribute = 'strat_sup_goals' AND MVL.OBJECT in ('application','asset', 'service', 'idea', 'other', 'product', 'project') 
								AND MVL.VALUE= ST.CHILD_ITEM 
							inner join INV_INVESTMENTS I
								on I.ID = MVL.PK_ID
						WHERE ST.PARENT_ITEM = ${vChild_Intl}
					</sql:query>
					<core:forEach items="${vContents.rowsByIndex}" var="row">
						<core:set var="vInv_Name">${row[0]}</core:set>
						<core:set var="vInv_Code">${row[1]}</core:set>
						<core:set var="vInv_Type">${row[2]}</core:set>
						<core:if test="${DebugLevel &gt; 0}">
							<gel:log level="debug" message="Found Investment: ${vInv_Code}-${vInv_Name}-${vInv_Type}."/> 
						</core:if>
			
						<gel:parse var="v_Content_Instance">
							<investment investmentID="${vInv_Code}" investmentType="${vInv_Type}"/>
						</gel:parse>
						<gel:set insert="true" select="$v_Portfolio_Instance/portfolio/contents" value="${v_Content_Instance}"/>
					</core:forEach>
				</core:if>
				
				<gel:set insert="true" select="$v_xml_portfolios/NikuDataBus/portfolios" value="${v_Portfolio_Instance}"/>
			</core:forEach>
			
			<!-- Processing Items Update -->
			<core:if test="${DebugLevel &gt; 1}">
				<gel:serialize var="${v_xml_items}" fileName="${XOGwebFolder}/XOGWrite_TopDown-Items_${vItem_Intl}.xml"/>
				<gel:log level="debug" message="XOG Write can be found at: ${XOGURL}/niku/XOGWrite_TopDown-Items_${vItem_Intl}"/> 
			</core:if>
			<!-- Calling XOG-->
			<core:catch var="v_xog_exception">
				<soap:invoke endpoint="${XOGURL}/niku/xog" var="runresultitems">
					<soap:message>
						<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xog="http://www.niku.com/xog">
							<soapenv:Header>
								<xog:Auth>
									<xog:SessionID>${sessionID}</xog:SessionID>
								</xog:Auth>	
							</soapenv:Header>
							<soapenv:Body>
								<gel:include select="$v_xml_items/NikuDataBus"/>
							</soapenv:Body>
						</soapenv:Envelope>
					</soap:message>
				</soap:invoke>
			</core:catch>
			<core:choose>
				<core:when test="${v_xog_exception != null}">
					<gel:log category="XOG" level="ERROR">XOG operation failed: ${v_xog_exception}</gel:log>
				</core:when>
				<core:otherwise>
					<gel:set select="$runresultitems/soapenv:Envelope/soapenv:Body/XOGOutput" var="writeOutputRoot"/>
					<gel:set asString="true" select="$writeOutputRoot/Status/@state" var="XOGoutcome"/>
					<gel:set asString="true" select="$writeOutputRoot/Records/Record" var="XOGoutputrecords"/>
					<gel:set asString="true" select="$writeOutputRoot/Statistics/@totalNumberOfRecords" var="XOGtotalrecords"/>
					<gel:set asString="true" select="$writeOutputRoot/Statistics/@insertedRecords" var="XOGinsertedrecords"/>
					<gel:set asString="true" select="$writeOutputRoot/Statistics/@updatedRecords" var="XOGupdatedrecords"/>
					<gel:set asString="true" select="$writeOutputRoot/Statistics/@failureRecords" var="XOGfailurerecords"/>
		
					<!-- Check the XOG result -->
					<gel:log category="XOG" level="INFO">[XOG]Document import for Items ${vItem_Intl} status:${XOGoutcome} Total Objs: ${XOGtotalrecords}, Total inserted: ${XOGinsertedrecords}, Total updated: ${XOGupdatedrecords}, Total failed: ${XOGfailurerecords}</gel:log>
				</core:otherwise>
			</core:choose>

			<core:if test="${DebugLevel &gt; 1}">
				<gel:serialize var="${runresultitems}" fileName="${XOGwebFolder}/XOGResults_TopDown-Items_${vItem_Intl}.xml"/>
				<gel:log level="debug" message="XOG Results can be found at: ${XOGURL}/niku/XOGResults_TopDown-Items_${vItem_Intl}.xml"/> 
			</core:if>

			<!-- Processing Portfolios Creation -->
			<core:if test="${DebugLevel &gt; 1}">
				<gel:serialize var="${v_xml_portfolios}" fileName="${XOGwebFolder}/XOGWrite_TopDown-Portfolios_${vItem_Intl}.xml"/>
				<gel:log level="debug" message="XOG Write can be found at: ${XOGURL}/niku/XOGWrite_TopDown-Portfolios_${vItem_Intl}"/> 
			</core:if>
			<!-- Calling XOG-->
			<core:catch var="v_xog_exception">
				<soap:invoke endpoint="${XOGURL}/niku/xog" var="runresultportfolios">
					<soap:message>
						<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xog="http://www.niku.com/xog">
							<soapenv:Header>
								<xog:Auth>
									<xog:SessionID>${sessionID}</xog:SessionID>
								</xog:Auth>	
							</soapenv:Header>
							<soapenv:Body>
								<gel:include select="$v_xml_portfolios/NikuDataBus"/>
							</soapenv:Body>
						</soapenv:Envelope>
					</soap:message>
				</soap:invoke>
			</core:catch>
			<core:choose>
				<core:when test="${v_xog_exception != null}">
					<gel:log category="XOG" level="ERROR">XOG operation failed: ${v_xog_exception}</gel:log>
				</core:when>
				<core:otherwise>
					<gel:set select="$runresultportfolios/soapenv:Envelope/soapenv:Body/XOGOutput" var="writeOutputRoot"/>
					<gel:set asString="true" select="$writeOutputRoot/Status/@state" var="XOGoutcome"/>
					<gel:set asString="true" select="$writeOutputRoot/Records/Record" var="XOGoutputrecords"/>
					<gel:set asString="true" select="$writeOutputRoot/Statistics/@totalNumberOfRecords" var="XOGtotalrecords"/>
					<gel:set asString="true" select="$writeOutputRoot/Statistics/@insertedRecords" var="XOGinsertedrecords"/>
					<gel:set asString="true" select="$writeOutputRoot/Statistics/@updatedRecords" var="XOGupdatedrecords"/>
					<gel:set asString="true" select="$writeOutputRoot/Statistics/@failureRecords" var="XOGfailurerecords"/>
		
					<!-- Check the XOG result -->
					<gel:log category="XOG" level="INFO">[XOG]Document import for Portfolios ${vItem_Intl} status:${XOGoutcome} Total Objs: ${XOGtotalrecords}, Total inserted: ${XOGinsertedrecords}, Total updated: ${XOGupdatedrecords}, Total failed: ${XOGfailurerecords}</gel:log>
				</core:otherwise>
			</core:choose>

			<core:if test="${DebugLevel &gt; 1}">
				<gel:serialize var="${runresultportfolios}" fileName="${XOGwebFolder}/XOGResults_TopDown-Portfolios_${vItem_Intl}.xml"/>
				<gel:log level="debug" message="XOG Results can be found at: ${XOGURL}/niku/XOGResults_TopDown-Portfolios_${vItem_Intl}.xml"/> 
			</core:if>
			
		</core:when>
		<core:otherwise>
			<gel:log category="XOG" level="ERROR" message="ERROR: Strategic Themes Target % Distribution do not add to 100%. Please correct and retry."/>
		</core:otherwise>
	</core:choose>

</gel:script>