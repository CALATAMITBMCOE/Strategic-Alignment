<gel:script xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:core="jelly:core"
    xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
    xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
    xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary"
    xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:sql="jelly:sql" xmlns:xog="http://www.niku.com/xog"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	
   	<!---------------------------------------------------------------->
	<!-- Package: Strategic Alignment 4.0 							-->
	<!-- Process: Strategic Fund Allocation Initialization			-->
	<!-- Step	: Initialize Allocated Fund							-->
	<!-- Action	: Initialize Allocated Fund							-->
	<!---------------------------------------------------------------->
	<!-- Object : Strategic Item (strategic_item)					-->
	<!---------------------------------------------------------------->
	<!-- Copy Top Down Funding values to Allocated Funding for 		-->
	<!-- Lower Level Items and Resets Allocated Funding for Parent	-->
	<!-- Items to zero. 											-->
	<!---------------------------------------------------------------->
	
    <core:set value="${gel_objectInstanceId}" var="vItem_Intl"/>
	
	<core:if test="${DebugLevel &gt; 0}">
		<gel:log level="debug" message="Start Script"/>
		<gel:log level="debug" message=">>Item ID             : ${vItem_Intl}"/> 
		<gel:log level="debug" message=">>Persisted XOG URL   : ${XOGURL}"/> 
		<gel:log level="debug" message=">>Persisted LOG Folder: ${XOGlogFolder}"/> 
		<gel:log level="debug" message=">>Persisted WEB Folder: ${XOGwebFolder}"/> 
		<gel:log level="debug" message=">>Persisted SessionID : ${sessionID}"/> 
		<gel:log level="debug" message=">>Persisted DebugLevel: ${DebugLevel}"/> 
	</core:if>

    <gel:setDataSource dbId="niku"/>
	
    <!-- Copy TopDown Funds to Allocated Funds for lower level items -->
    <sql:update escapeText="false" var="vItemFields">
		UPDATE ODF_CA_STRATEGIC_ITEM 
			Set strat_alloc_funding = strat_top_down_fund,
				strat_alloc_benefit = strat_td_benefit,
				strat_alloc_fte = strat_td_fte,
				last_updated_date = sysdate,
				last_updated_by = 1 
		WHERE ODF_CA_STRATEGIC_ITEM.ID 
			IN (select TF.CHILD_ITEM 
				FROM ODF_CA_STRAT_TREE_FLAT TF
				where TF.PARENT_ITEM = ${vItem_Intl})
		AND not exists (select 'x' from ODF_CA_STRATEGIC_ITEM c where c.parentitem = ODF_CA_STRATEGIC_ITEM.ID )
	</sql:update>

    <!-- Zero  Allocated Funds for top level items -->
    <sql:update escapeText="false" var="vItemFields">
		UPDATE ODF_CA_STRATEGIC_ITEM 
			Set strat_alloc_funding = 0,
				strat_alloc_benefit = 0,
				strat_alloc_fte = 0,
				last_updated_date = sysdate,
				last_updated_by = 1 
		WHERE ODF_CA_STRATEGIC_ITEM.ID 
			IN (select TF.CHILD_ITEM 
				FROM ODF_CA_STRAT_TREE_FLAT TF
				where TF.PARENT_ITEM = ${vItem_Intl})
		AND exists (select 'x' from ODF_CA_STRATEGIC_ITEM c where c.parentitem = ODF_CA_STRATEGIC_ITEM.ID )
	</sql:update>
	
</gel:script>